<!DOCTYPE html>
<html lang="vi" class="h-full">
<script>
// Simple initialization
document.addEventListener('DOMContentLoaded', function() {
  console.log('Document ready');
});
</script>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deloris - AI Nhận thức UPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --primary-light: #818cf8;
        --bg-dark: #ffffff;
        --bg-darker: #f8fafc;
        --bg-light: #ffffff;
        --bg-lighter: #f9fafb;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --success: #059669;
        --warning: #d97706;
        --danger: #dc2626;
        --border: #e5e7eb;
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background: #ffffff;
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
        overflow-y: auto;
      }
      
      .sidebar {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #ffffff;
        border-right: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
      }
      #chat-window::-webkit-scrollbar {
        width: 6px;
      }
      #chat-window::-webkit-scrollbar-track {
        background: #1e293b;
      }
      #chat-window::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 3px;
      }
      .deloris-bubble {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .user-bubble {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border: 1px solid var(--primary-light);
        border-radius: 1rem;
        color: white;
      }
      /* Adjusted UPT data style */
      .upt-data {
        font-size: 0.65rem; /* Slightly smaller */
        color: #94a3b8;
        margin-top: 8px;
        border-top: 1px solid #475569;
        padding-top: 6px;
        line-height: 1.3; /* Better spacing for multiple lines */
        word-break: break-word; /* Ensure long strings wrap */
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #22c55e;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      /* Upload section visibility (do not force modals visible) */
      #upload-section {
        display: block;
      }
      .hidden {
        display: none !important;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
      .loader {
        border: 2px solid #475569;
        border-top: 2px solid #6366f1;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Feedback button styles */
      .feedback-buttons {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 6px;
      }
      .feedback-button {
        font-size: 0.7rem;
        padding: 2px 6px;
        margin-left: 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 1px solid #475569;
        background-color: transparent;
        color: #94a3b8;
      }
      .feedback-button:hover:not(:disabled) {
        background-color: #475569;
      }
      .feedback-button.good:hover:not(:disabled) {
        background-color: #10b981;
        color: #0f172a;
        border-color: #10b981;
      }
      .feedback-button.bad:hover:not(:disabled) {
        background-color: #f87171;
        color: #0f172a;
        border-color: #f87171;
      }
      .feedback-button:disabled {
        cursor: not-allowed;
        opacity: 0.4;
      }
      .feedback-saved {
        font-size: 0.7rem;
        color: #6ee7b7;
        margin-left: 5px;
      } /* Style for "Saved" text */
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="flex flex-col h-screen">
    <header class="bg-gradient-to-r from-slate-900/90 to-slate-800/90 backdrop-blur-md border-b border-slate-700/50 p-4 flex justify-between items-center sticky top-0 z-20">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center">
          <i class="fas fa-robot text-white"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-indigo-400">Deloris AI</h1>
          <p class="text-xs text-slate-400 font-medium">Unified Pulse Theory - AI Nhận thức</p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <button id="upload-btn" class="text-sm px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white rounded-lg transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-purple-500/20">
          <i class="fas fa-upload"></i>
          <span>Tải lên dữ liệu</span>
        </button>
        <div class="flex items-center space-x-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700/50">
          <div class="status-dot"></div>
          <span class="text-sm font-medium text-green-400">Đang hoạt động</span>
        </div>
      </div>
    </header>

    <main class="flex-1 container mx-auto px-4 py-6 w-full max-w-4xl">
      <section class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-medium">Chat</h2>
          <div class="flex items-center space-x-3">
            <label class="text-sm">Entanglement</label>
            <input id="entanglement-slider" type="range" min="0" max="1" step="0.01" value="0.5" class="w-44">
            <span id="entanglement-value" class="w-12 text-sm">0.50</span>
          </div>
        </div>
        <div id="chat-window" class="bg-white rounded-lg p-4 overflow-y-auto border border-gray-200 shadow-sm"></div>
      </section>

      <section class="mb-6">
        <form id="chat-form" class="flex space-x-3 items-end">
          <textarea id="message-input" rows="2" placeholder="Nhập tin nhắn..." class="flex-1 p-3 rounded-lg border border-gray-300 resize-none"></textarea>
          <button id="send-button" type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Gửi</button>
        </form>
      </section>

      <section class="mb-6">
        <h3 class="text-lg font-medium mb-2">Tải lên tệp (tùy chọn)</h3>
        <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
          <input id="file-input" type="file" class="mb-3" />
          <div class="flex items-center space-x-3">
            <button id="upload-button" class="px-4 py-2 bg-green-600 text-white rounded-lg">Tải lên</button>
            <button id="list-files" class="px-3 py-2 bg-gray-100 rounded-lg">Danh sách tệp</button>
            <div id="upload-status" class="text-sm text-gray-600 ml-3"></div>
          </div>

          <div id="files-list" class="mt-3 text-sm text-gray-700"></div>
        </div>
      </section>

      <section>
        <h3 class="text-sm text-gray-500 mb-1">Ghi chú</h3>
        <p class="text-xs text-gray-600">Giao diện mới, đơn giản. Nếu muốn persona/nâng cấp Deloris, chọn tùy chọn tiếp theo.</p>
      </section>
    </main>

    <footer class="p-4 text-center text-xs text-gray-500">Deloris • Local</footer>

    <script>
      // Small helper to append messages
      function addMessage(author, text, type='deloris'){
        const win = document.getElementById('chat-window');
        const wrap = document.createElement('div');
        wrap.className = type === 'user' ? 'flex justify-end mb-3' : 'flex justify-start mb-3';
        const bubble = document.createElement('div');
        bubble.className = 'bubble p-3 rounded-xl shadow-sm ' + (type === 'user' ? 'user' : (type === 'sys' ? 'sys' : 'deloris'));
        const meta = document.createElement('div'); meta.className = 'text-xs opacity-80 mb-1'; meta.textContent = author;
        const content = document.createElement('div'); content.className = 'text-sm'; content.textContent = text;
        bubble.appendChild(meta); bubble.appendChild(content); wrap.appendChild(bubble); win.appendChild(wrap);
        win.scrollTop = win.scrollHeight;
      }

      // Entanglement slider
      const ent = document.getElementById('entanglement-slider');
      const entVal = document.getElementById('entanglement-value');
      ent.addEventListener('input', ()=> entVal.textContent = parseFloat(ent.value).toFixed(2));

      // Chat submit
      const form = document.getElementById('chat-form');
      const input = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-button');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = input.value.trim();
        if(!text) return;
        addMessage('Bạn', text, 'user');
        input.value=''; sendBtn.disabled=true;
        try{
          const response = await fetch('/chat', {
          	method:'POST', headers: {'Content-Type':'application/json'},
          	body: JSON.stringify({ message: text, entanglement: parseFloat(ent.value) })
          });
          const data = await response.json();
          const reply = data.deloris_response || 'Deloris không trả lời.';
          addMessage('Deloris', reply, 'deloris');
          if(data.upt_data) addMessage('Hệ thống', data.upt_data, 'sys');
        }catch(err){
          console.error(err); addMessage('Hệ thống', 'Lỗi kết nối đến máy chủ.', 'sys');
        }finally{ sendBtn.disabled=false; }
      });

      // File upload
      const fileInput = document.getElementById('file-input');
      const uploadBtn = document.getElementById('upload-button');
      const uploadStatus = document.getElementById('upload-status');
      const filesList = document.getElementById('files-list');
      const listBtn = document.getElementById('list-files');

      uploadBtn.addEventListener('click', async ()=>{
        const f = fileInput.files[0];
        if(!f){ uploadStatus.textContent = 'Chưa chọn tệp.'; return; }
        const fd = new FormData(); fd.append('file', f);
        uploadStatus.textContent = 'Đang tải lên...';
        try{
          const res = await fetch('/upload', { method:'POST', body: fd });
          const j = await res.json().catch(()=>({}));
          if(res.ok){ uploadStatus.textContent = 'Tải lên thành công.'; addMessage('Hệ thống', 'Đã tải lên: '+f.name, 'sys'); }
          else { uploadStatus.textContent = 'Lỗi: '+(j.error||res.status); }
        }catch(err){ uploadStatus.textContent='Lỗi tải lên.'; console.error(err); }
      });

      listBtn.addEventListener('click', async ()=>{
        filesList.textContent = 'Đang tải...';
        try{
          const res = await fetch('/api/files');
          const arr = await res.json();
          if(Array.isArray(arr)){
            if(arr.length===0) filesList.textContent='Không có tệp.';
            else filesList.innerHTML = arr.map(f=>`<div class="p-2 border-b">${f.name} • ${f.size} bytes</div>`).join('');
          } else { filesList.textContent = 'Không thể lấy danh sách tệp.'; }
        }catch(err){ filesList.textContent='Lỗi.'; }
      });

      // Defensive: hide leftover full-screen overlays (if any)
      (function(){
        function removeLargeOverlays(){
          try{
            const vw=innerWidth, vh=innerHeight; let removed=0;
            Array.from(document.body.children).forEach(el=>{
              const r=el.getBoundingClientRect();
              if(r.width>vw*0.7 && r.height>vh*0.5){
                const s=getComputedStyle(el);
                if((s.backgroundColor && s.backgroundColor.indexOf('rgba')!==-1 && s.backgroundColor.indexOf(', 0.9')===-1) || s.backdropFilter){ el.style.display='none'; el.style.pointerEvents='none'; removed++; }
              }
            });
            if(removed){ const t=document.createElement('div'); t.textContent='Overlay auto-removed'; t.style.position='fixed'; t.style.right='12px'; t.style.bottom='12px'; t.style.background='#059669'; t.style.color='#fff'; t.style.padding='6px 10px'; t.style.borderRadius='6px'; t.style.zIndex=99999; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
          }catch(e){console.error(e)}
        }
        addEventListener('load', removeLargeOverlays); setTimeout(removeLargeOverlays,300); setTimeout(removeLargeOverlays,1200);
      })();
    </script>
  </body>
</html>
